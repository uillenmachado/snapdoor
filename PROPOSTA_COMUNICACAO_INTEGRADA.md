# ğŸ“§ **PROPOSTA: Sistema de ComunicaÃ§Ã£o Integrado - SnapDoor CRM**

**Data**: 17 de outubro de 2025
**Objetivo**: Enriquecer a pÃ¡gina de Oportunidades com comunicaÃ§Ã£o rastreada (Email, WhatsApp, Calls)

---

## ğŸ¯ **VISÃƒO GERAL**

### **Conceito (inspirado em Pipedrive/HubSpot)**:
A pÃ¡gina de detalhes da oportunidade Ã© o **hub central** onde acontecem todas as interaÃ§Ãµes:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DETALHES DA OPORTUNIDADE                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   EMPRESA    â”‚  â”‚    LEADS     â”‚  â”‚  VALOR   â”‚  â”‚
â”‚  â”‚   Acme Corp  â”‚  â”‚  3 contatos  â”‚  â”‚ R$ 50k   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  TIMELINE DE ATIVIDADES                         â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚  ğŸ“§ Email enviado - "Proposta comercial"       â”‚â”‚
â”‚  â”‚     Para: joao@acme.com                         â”‚â”‚
â”‚  â”‚     Aberto: Sim | Clicou: NÃ£o                   â”‚â”‚
â”‚  â”‚     HÃ¡ 2 horas                                   â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚  ğŸ“ LigaÃ§Ã£o realizada - 15min                   â”‚â”‚
â”‚  â”‚     Com: Maria (CFO)                             â”‚â”‚
â”‚  â”‚     Notas: "Interessada, pediu desconto"        â”‚â”‚
â”‚  â”‚     Ontem Ã s 14:30                               â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚  ğŸ’¬ WhatsApp - "Follow-up proposta"            â”‚â”‚
â”‚  â”‚     Entregue âœ“âœ“ | Lido âœ“âœ“                      â”‚â”‚
â”‚  â”‚     Anteontem                                    â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  [ğŸ“§ Enviar Email] [ğŸ“ Registrar LigaÃ§Ã£o]      â”‚â”‚
â”‚  â”‚  [ğŸ’¬ WhatsApp]     [ğŸ“ Adicionar Nota]         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” **ANÃLISE DAS APIs DISPONÃVEIS**

### **âœ… APIs JÃ CONFIGURADAS** (no .env):

#### **1. Supabase** âœ…
- **Status**: Configurado e funcionando
- **Uso**: Banco de dados, auth, storage
- **Potencial**: 
  - âœ… Armazenar emails enviados
  - âœ… Timeline de atividades
  - âœ… Anexos de emails
  - âœ… Real-time updates

#### **2. Resend** âœ… **PERFEITO PARA EMAILS**
```env
RESEND_API_KEY=re_BZM9Y2pf_9emjJJ3vkSjqCurb15kmd6K4
RESEND_FROM_EMAIL=onboarding@resend.dev
RESEND_FROM_NAME="SnapDoor CRM"
```

**Capacidades**:
- âœ… Enviar emails transacionais
- âœ… Rastrear aberturas (open tracking)
- âœ… Rastrear cliques (click tracking)
- âœ… Webhooks para status de entrega
- âœ… Templates personalizÃ¡veis
- âœ… Anexos
- âœ… **DOMÃNIO PRÃ“PRIO** (onboarding@resend.dev â†’ comercial@snapdoor.com.br)

**PreÃ§o**: GrÃ¡tis atÃ© 100 emails/dia, depois $20/mÃªs

#### **3. Hunter.io** âœ…
```env
VITE_HUNTER_API_KEY=c2e0acf158a10a3c0253b49c006a80979679cc5c
```

**Capacidades**:
- âœ… Descobrir emails de empresas
- âœ… Verificar validade de emails
- âœ… Enriquecer dados de contatos

#### **4. Stripe** âœ…
```env
VITE_STRIPE_PUBLISHABLE_KEY=pk_test_...
```
- JÃ¡ configurado para pagamentos

#### **5. Sentry** âœ…
- Monitoramento de erros

---

### **âŒ APIs QUE PRECISAMOS ADICIONAR**:

#### **1. Para WhatsApp - Twilio** âš ï¸ RECOMENDADO
**Por quÃª?**
- API oficial do WhatsApp Business
- Rastreamento de mensagens
- Webhooks para status (enviado, entregue, lido)
- Templates aprovados pelo Meta

**ConfiguraÃ§Ã£o necessÃ¡ria**:
```env
TWILIO_ACCOUNT_SID=ACxxxxx
TWILIO_AUTH_TOKEN=xxxxx
TWILIO_WHATSAPP_NUMBER=whatsapp:+14155238886
```

**PreÃ§o**: 
- $0.005 por mensagem (R$ 0,025)
- ViÃ¡vel para CRM

**Alternativa**: **WPPConnect** (self-hosted, gratuito, mas menos estÃ¡vel)

#### **2. Para LigaÃ§Ãµes - Twilio Voice** âš ï¸ RECOMENDADO
**Por quÃª?**
- GravaÃ§Ã£o de chamadas
- TranscriÃ§Ã£o automÃ¡tica (IA)
- Call tracking
- IntegraÃ§Ã£o com CRM

**ConfiguraÃ§Ã£o**:
```env
TWILIO_PHONE_NUMBER=+5511999999999
```

**PreÃ§o**:
- LigaÃ§Ãµes: $0.02/min (R$ 0,10/min)
- GravaÃ§Ãµes: incluÃ­das

---

## ğŸ’¡ **PROPOSTA DE SOLUÃ‡ÃƒO - FASE 1 (MVP)**

### **ğŸ¯ Objetivo**: Sistema de Email integrado com rastreamento

### **Stack Recomendada**:

```
Frontend (React)
â”œâ”€ Composer de Email (rich text editor)
â”œâ”€ Modal de envio
â”œâ”€ Timeline de emails
â””â”€ Indicadores de status (aberto, clicado)

Backend (Supabase Edge Functions)
â”œâ”€ /send-email â†’ Integra com Resend
â”œâ”€ /email-webhook â†’ Recebe status do Resend
â””â”€ /track-open â†’ Pixel de rastreamento

Database (Supabase)
â”œâ”€ activities (emails, calls, whatsapp, notas)
â”œâ”€ email_threads (conversas agrupadas)
â””â”€ email_tracking (opens, clicks)
```

---

## ğŸ“Š **ESTRUTURA DO BANCO DE DADOS**

### **Tabela: `activities`** (jÃ¡ existe, vamos expandir)

```sql
CREATE TABLE activities (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  deal_id UUID REFERENCES deals(id) ON DELETE CASCADE,
  lead_id UUID REFERENCES leads(id) ON DELETE SET NULL,
  company_id UUID REFERENCES companies(id) ON DELETE SET NULL,
  
  -- Tipo de atividade
  type TEXT NOT NULL CHECK (type IN (
    'email', 'call', 'whatsapp', 'meeting', 
    'note', 'task', 'linkedin_message'
  )),
  
  -- DireÃ§Ã£o (para emails/whatsapp)
  direction TEXT CHECK (direction IN ('inbound', 'outbound')),
  
  -- Dados da atividade (JSONB flexÃ­vel)
  data JSONB DEFAULT '{}',
  -- Para EMAIL: {
  --   subject: "Proposta comercial",
  --   body_html: "<p>OlÃ¡!</p>",
  --   to: ["joao@acme.com"],
  --   cc: [],
  --   bcc: [],
  --   attachments: [],
  --   message_id: "resend-id-123",
  --   thread_id: "uuid"
  -- }
  -- Para CALL: {
  --   duration: 900, // segundos
  --   recording_url: "https://...",
  --   notes: "Cliente interessado"
  -- }
  -- Para WHATSAPP: {
  --   message: "OlÃ¡, tudo bem?",
  --   media_url: "https://...",
  --   status: "delivered"
  -- }
  
  -- Status da atividade
  status TEXT DEFAULT 'completed',
  -- Para emails: 'sent', 'delivered', 'opened', 'clicked', 'bounced', 'failed'
  -- Para calls: 'scheduled', 'completed', 'missed', 'cancelled'
  
  -- Rastreamento (apenas para emails)
  opened_at TIMESTAMPTZ,
  clicked_at TIMESTAMPTZ,
  bounced_at TIMESTAMPTZ,
  
  -- Metadata
  scheduled_for TIMESTAMPTZ,
  completed_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Ãndices
CREATE INDEX idx_activities_deal_id ON activities(deal_id);
CREATE INDEX idx_activities_type ON activities(type);
CREATE INDEX idx_activities_created_at ON activities(created_at DESC);
```

---

## ğŸš€ **IMPLEMENTAÃ‡ÃƒO PROPOSTA**

### **FASE 1: Email Tracking** (2-3 dias)

#### **1.1 - Estrutura do Banco** âœ…
```sql
-- Migration jÃ¡ proposta acima
```

#### **1.2 - Supabase Edge Function: send-email**
```typescript
// supabase/functions/send-email/index.ts
import { serve } from "https://deno.land/std@0.168.0/http/server.ts"
import { createClient } from '@supabase/supabase-js'
import { Resend } from 'resend'

const resend = new Resend(Deno.env.get('RESEND_API_KEY'))

serve(async (req) => {
  try {
    const { dealId, to, subject, html, userId } = await req.json()
    
    // 1. Enviar email via Resend
    const { data, error } = await resend.emails.send({
      from: 'comercial@snapdoor.com.br',
      to: to,
      subject: subject,
      html: html,
      // Habilitar tracking
      headers: {
        'X-Entity-Ref-ID': dealId, // Para rastrear
      },
    })
    
    if (error) throw error
    
    // 2. Salvar no banco
    const supabase = createClient(...)
    await supabase.from('activities').insert({
      user_id: userId,
      deal_id: dealId,
      type: 'email',
      direction: 'outbound',
      status: 'sent',
      data: {
        subject,
        body_html: html,
        to: [to],
        message_id: data.id,
      },
    })
    
    return new Response(JSON.stringify({ success: true }))
  } catch (error) {
    return new Response(JSON.stringify({ error }), { status: 500 })
  }
})
```

#### **1.3 - Componente React: EmailComposer**
```tsx
// src/components/EmailComposer.tsx
export function EmailComposer({ dealId, leadEmail }) {
  const [subject, setSubject] = useState('')
  const [body, setBody] = useState('')
  const sendMutation = useMutation({
    mutationFn: async () => {
      const { data } = await supabase.functions.invoke('send-email', {
        body: { dealId, to: leadEmail, subject, html: body }
      })
      return data
    },
    onSuccess: () => {
      toast.success('Email enviado!')
    }
  })
  
  return (
    <Dialog>
      <DialogTrigger asChild>
        <Button>
          <Mail className="h-4 w-4 mr-2" />
          Enviar Email
        </Button>
      </DialogTrigger>
      <DialogContent className="max-w-2xl">
        <DialogHeader>
          <DialogTitle>Enviar Email</DialogTitle>
        </DialogHeader>
        <div className="space-y-4">
          <Input 
            placeholder="Assunto" 
            value={subject}
            onChange={(e) => setSubject(e.target.value)}
          />
          <ReactQuill 
            value={body} 
            onChange={setBody}
            modules={{ toolbar: [...] }}
          />
          <Button onClick={() => sendMutation.mutate()}>
            Enviar
          </Button>
        </div>
      </DialogContent>
    </Dialog>
  )
}
```

#### **1.4 - Timeline de Atividades**
```tsx
// src/components/ActivityTimeline.tsx
export function ActivityTimeline({ dealId }) {
  const { data: activities } = useQuery({
    queryKey: ['activities', dealId],
    queryFn: async () => {
      const { data } = await supabase
        .from('activities')
        .select('*')
        .eq('deal_id', dealId)
        .order('created_at', { ascending: false })
      return data
    }
  })
  
  return (
    <div className="space-y-4">
      {activities?.map(activity => (
        <Card key={activity.id}>
          <CardHeader>
            <div className="flex items-center gap-2">
              {activity.type === 'email' && <Mail />}
              {activity.type === 'call' && <Phone />}
              {activity.type === 'whatsapp' && <MessageCircle />}
              <span className="font-medium">
                {activity.data.subject || activity.type}
              </span>
              {activity.opened_at && (
                <Badge variant="success">Aberto</Badge>
              )}
            </div>
          </CardHeader>
          <CardContent>
            <p>{activity.data.body_text}</p>
            <p className="text-sm text-muted-foreground mt-2">
              {formatDistanceToNow(activity.created_at)} atrÃ¡s
            </p>
          </CardContent>
        </Card>
      ))}
    </div>
  )
}
```

---

### **FASE 2: WhatsApp Integration** (3-4 dias)

**OpÃ§Ã£o A: Twilio (Profissional)**
- Setup: Criar conta Twilio
- AprovaÃ§Ã£o do Meta (2-7 dias)
- Templates prÃ©-aprovados
- Webhooks para status

**OpÃ§Ã£o B: WPPConnect (Open Source)**
- Self-hosted (Docker)
- Mais controle
- Menos estÃ¡vel
- Gratuito

---

### **FASE 3: Call Tracking** (2-3 dias)

**Recursos**:
- BotÃ£o "Registrar LigaÃ§Ã£o"
- Campos: DuraÃ§Ã£o, Notas, Participantes
- Upload de gravaÃ§Ã£o (opcional)
- IntegraÃ§Ã£o com Twilio Voice (futuro)

---

## ğŸ’° **CUSTOS ESTIMADOS**

### **Resend (Email)**:
- GrÃ¡tis: 100 emails/dia (3.000/mÃªs)
- Pro: $20/mÃªs (50.000 emails)
- **RecomendaÃ§Ã£o**: ComeÃ§ar no free tier

### **Twilio (WhatsApp + Voice)**:
- WhatsApp: $0.005/msg (~R$ 0,025)
- Voice: $0.02/min (~R$ 0,10/min)
- **Estimativa**: R$ 50-200/mÃªs (uso moderado)

### **Total**: ~R$ 100-300/mÃªs para operaÃ§Ã£o completa

---

## ğŸ“‹ **ROADMAP SUGERIDO**

### **Sprint 1 (Esta semana)**:
- [x] AnÃ¡lise de APIs âœ…
- [ ] Migration: activities table expandida
- [ ] Supabase Function: send-email
- [ ] Componente: EmailComposer
- [ ] Componente: ActivityTimeline

### **Sprint 2 (PrÃ³xima semana)**:
- [ ] Webhook Resend (tracking de aberturas)
- [ ] Testes de envio de email
- [ ] Templates de email prÃ©-definidos
- [ ] HistÃ³rico de emails por lead

### **Sprint 3**:
- [ ] IntegraÃ§Ã£o WhatsApp (Twilio ou WPPConnect)
- [ ] Call logging
- [ ] Upload de gravaÃ§Ãµes

### **Sprint 4**:
- [ ] Email threading (conversas agrupadas)
- [ ] Respostas inline
- [ ] IntegraÃ§Ã£o com Gmail/Outlook (OAuth2)

---

## â“ **DECISÃ•ES NECESSÃRIAS**

### **1. Email - DomÃ­nio PrÃ³prio?**
- â“ Usar `comercial@snapdoor.com.br`?
- â“ Ou `noreply@snapdoor.com.br`?
- **AÃ§Ã£o**: Configurar DNS do domÃ­nio no Resend

### **2. WhatsApp - Qual soluÃ§Ã£o?**
- âœ… **Twilio**: Profissional, estÃ¡vel, pago
- âš ï¸ **WPPConnect**: Gratuito, self-hosted, risco de ban

### **3. Rich Text Editor?**
- âœ… **React-Quill**: Simples, leve
- âš ï¸ **TipTap**: Moderno, mais features
- âš ï¸ **Draft.js**: Complexo

---

## ğŸ¯ **PRÃ“XIMOS PASSOS IMEDIATOS**

1. âœ… **VocÃª decide**: 
   - ComeÃ§ar com Email (Resend)?
   - Configurar domÃ­nio prÃ³prio?
   - Qual soluÃ§Ã£o de WhatsApp?

2. **Eu implemento**:
   - Migration da tabela activities
   - Supabase Edge Function
   - Componentes React

3. **Testamos juntos**:
   - Envio de email
   - Rastreamento
   - Timeline

---

**Aguardo suas decisÃµes para comeÃ§armos! ğŸš€**

Qual fase vocÃª quer priorizar?
1. ğŸ“§ Email (mais fÃ¡cil, rÃ¡pido)
2. ğŸ’¬ WhatsApp (requer setup)
3. ğŸ“ Call Tracking (simples registro)
